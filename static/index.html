<!DOCTYPE html>
<html lang="en" ng-app="countriesNewsApp">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Interactive Map</title>
  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="css/custom.css" rel="stylesheet">
  <link href="css/map.css" rel="stylesheet">
  <script src="http://code.jquery.com/jquery-2.0.0.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="js/angular.min.js"></script>
  <script src="js/controllers.js"></script>
  <script src="js/angular-route.js"></script>
</head>
<body>
  <div class="site-wrapper">
   <div class="site-wrapper-inner">
    <div class="container" style="padding-top: 30px;">
     <div class="inner cover">
      <h1 class="cover-heading">View Your News by Country.</h1>
      <p class="lead">Just click on a country and go.</p>
    </div>


    <form role="form" class="form-inline">
     <div class="form-group">
      <input type="text" class="form-control form-control-sm" id="query" 
      placeholder="Search Topic">
    </div>
    <button type="submit" id="search" class="btn btn-default">Go!</button>
  </form>

  <form role="form" class="form-inline">
   <div class="form-group">
    <input type="text" class="form-control form-control-sm" id="place" 
    placeholder="Search Place">
  </div>
  <button type="submit" id="searchPlace" class="btn btn-default">Go!</button>
</form>



<div class="row" style="margin-bottom: 40px;">
  <div class="col-md-8">
   <div id="map" style="width: 700px; margin: 40px 40px 5px 40px;"></div>
   <small>Map by <a href="http://www.tnoda.com/">tnoda</a></small>
 </div>
 <div class="col-md-4" ng-controller="NewsListCtrl">


   <div class="articles-box">
     <div id="title">
       <h3 class="text-center" style="margin-top: 10px;">News Stories Here</h3>
     </div>
     <div class="articles">
      <ul class="list-unstyled" style="margin-bottom: 0px;">
       <li ng-repeat="story in stories | orderBy:orderProp">
        <div class="story">
         <p>{{story.title}}</p>
         <small class="text-muted">{{story.summary}}</small>
       </div>
     </li>
   </ul>

   <!-- <div id="stories"></div> -->

 </div>

</div>
</div>
<div class="container">
 <div class="footer">
  <p>Project by Robert Kuykendall, Shensi Ding, Sahil Ansari and Bo Xu.</p>
</div>
</div>
</div>
</div>

<!-- Start Map Code -->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>
var places;
 $(document).ready(function()
 {
   $( "#search" ).click(function( event ) {
     requestStories($( "#query" ).val());

           // $("#query").submit();
           event.preventDefault();
         });

   $( "#query" ).submit(function( event ) {
     console.log( $( "#query" ).val());
     requestStories($( "#query" ).val());

     event.preventDefault();
   });


   $( "#searchPlace" ).click(function( event ) {
             // $("#place").submit();
             // url = "/"+$( "#place" ).val()+"_articles.json";
             // console.log(url);

             // $.getJSON(url, function(data) {
             //   var items = [];
             //   $.each( data, function( key, val ) {
             //     items.push( "<li id='" + key + "'>" + val + "</li>" );
             //   });

             //   $(".story").html("<ul>"+items.join("\n")+"</ul>")
             //   $("#title").html("<ul>"+$( "#place" ).val()+"</ul>")
             // });
   requestStories($( "#place" ).val());
   event.preventDefault();
   return false;      
 });

   $( "#place" ).submit(function( event ) {
     console.log( $( "#place" ).val());
     event.preventDefault();
   });

   event.preventDefault();
 });

var m_width = $("#map").width(),
width = 938,
height = 500,
country,
state;

var projection = d3.geo.mercator()
.scale(150)
.translate([width / 2, height / 1.5]);

var path = d3.geo.path()
.projection(projection);

var svg = d3.select("#map").append("svg")
.attr("preserveAspectRatio", "xMidYMid")
.attr("viewBox", "0 0 " + width + " " + height)
.attr("width", m_width)
.attr("height", m_width * height / width);

svg.append("rect")
.attr("class", "background")
.attr("width", width)
.attr("height", height)
.on("click", country_clicked);


var g = svg.append("g");
d3.json("json/countries.topo.json", function(error, us) {
 g.append("g")
 .attr("id", "countries")
 .selectAll("path")
 .data(topojson.feature(us, us.objects.countries).features)
 .enter()
 .append("path")
 .attr("id", function(d) { return d.id; })
 .attr("d", path)
 .on("click", country_clicked);
});

function zoom(xyz) {
 g.transition()
 .duration(750)
 .attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
 .selectAll(["#countries", "#states"])
 .style("stroke-width", 1.0 / xyz[2] + "px")
 .selectAll(".city")
 .attr("d", path.pointRadius(20.0 / xyz[2]));
}

function get_xyz(d) {
 var bounds = path.bounds(d);
 var w_scale = (bounds[1][0] - bounds[0][0]) / width;
 var h_scale = (bounds[1][1] - bounds[0][1]) / height;
 var z = .96 / Math.max(w_scale, h_scale);
 var x = (bounds[1][0] + bounds[0][0]) / 2;
 var y = (bounds[1][1] + bounds[0][1]) / 2 + (height / z / 6);
 return [x, y, z];
}




function country_clicked(d) {
           // g.selectAll(["#states"]).remove();
           // state = null;

           // if (country) {
           //   g.selectAll("#" + country.id).style('display', null);
           // }

           // if (d && country !== d) {
           //   var xyz = get_xyz(d);
           //   country = d;

           //   if (d.id == 'USA') {
           //     d3.json("data/json/states_" + d.id.toLowerCase() + ".topo.json", function(error, us) {
           //       g.append("g")
           //       .attr("id", "states")
           //       .selectAll("path")
           //       .data(topojson.feature(us, us.objects.states).features)
           //       .enter()
           //       .append("path")
           //       .attr("id", function(d) { return d.id; })
           //       .attr("class", "active")
           //       .attr("d", path)
           //       .on("click", state_clicked);

           //       // zoom(xyz);
           //       g.selectAll("#" + d.id).style('display', 'none');
           //     });
           //   } else {
           //     // zoom(xyz);
           //   }
           // } else {
           //   var xyz = [width / 2, height / 1.5, 1];
           //   country = null;
           //   // zoom(xyz);
           // }
           
           // // $.getJSON("/"+d.properties.name+"_articles.json", function(data) {
           // $.getJSON("json/us_articles.json", function(data) {
           //   var items = [];
           //   // alert("getting data!");
           // 	$.each( data, function( key, val ) {
           	
           // 	$.each( story, function( key, val ) {
           //     	items.push( "<li id='" + items.length + key + "'>" + val + "</li>" );
           //     });

           //   });

           //   $("#stories").html("<ul>"+items.join("\n")+"</ul>")
           // });



requestStories(d.properties.name);



// var places = [
// {
//   name: "Wollongong, Australia",
//   location: {
//     latitude: -34.42507,
//     longitude: 150.89315
//   }
// },
// {
//   name: "Newcastle, Australia",
//   location: {
//     latitude: -32.92669,
//     longitude: 151.77892
//   }
// }
// ]



// svg.selectAll(".pin")
// .data(places)
// .enter().append("circle", ".pin")
// .attr("r", 5)
// .attr("transform", function(d) {
//   return "translate(" + projection([
//     d.location.longitude,
//     d.location.latitude
//     ]) + ")"
// });

}

function state_clicked(d) {

 if (d && state !== d) {
   var xyz = get_xyz(d);
   state = d;

   country_code = state.id.substring(0, 3).toLowerCase();
   state_name = state.properties.name;

   zoom(xyz);
 } else {
   state = null;
   country_clicked(country);
 }
}

function requestStories(query){
  $("#title").html("<h3 class=\"text-center\" style=\"margin-top: 10px;\">"+query+"</h3>");

  $(".articles").html("<br><br><div class=\"progress progress-striped active\" style=\"margin: 30px;\">"
   + "<div class=\"progress-bar\"  role=\"progressbar\" aria-valuenow=\"50\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 50%\">"
   + "<span class=\"sr-only\">50% Complete</span></div></div>"
   );





  url = "/"+query+"_articles.json";
             // console.log(query);
             // var places;
             $.getJSON(url, function(data) {
               var items = [];
               
               
               $.each( data, function( key, val ) {
                 items.push( "<div class=\"story\">"
                 	+ "<p>"+val.title+"</p><small class=\"text-muted\">" + val.summary + "</small></div>" );

                 console.log(val.country);
                 console.log(val.long);
                 console.log(val.lat);


                 places = [
                 {
                  name: val.country,
                  location: {
                    latitude: val.long,
                    longitude: val.lat
                  }
                }
                ]

              });

          /*
               $.each( data, function( key, val ) {
                 items.push( "<li id='" + key + "'>" + val + "</li>" );
               });
*/
$(".articles").html("<ul class=\"list-unstyled\" style=\"margin-bottom: 0px;\">"+items.join("\n")+"</ul>")

});

}

$(window).resize(function() {
 var w = $("#map").width();
 svg.attr("width", w);
 svg.attr("height", w * height / width);
});
</script>
<!-- End Map Code -->

      <!-- Bootstrap core JavaScript
      ================================================== -->
      <!-- Placed at the end of the document so the pages load faster -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script src="js/bootstrap.min.js"></script>
      <script src="http://getbootstrap.com/assets/js/docs.min.js"></script>
    </body>
    </html>